<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Linglear – Login Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a, #020617);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      backdrop-filter: blur(18px);
      background: rgba(15, 23, 42, 0.8);
      border-radius: 24px;
      padding: 24px 28px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.3);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.25), transparent 60%);
      opacity: 0.6;
      pointer-events: none;
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 0.25rem;
    }
    p {
      margin-top: 0;
      color: #9ca3af;
      font-size: 0.95rem;
    }
    button {
      border-radius: 9999px;
      padding: 10px 18px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0b1120;
      box-shadow: 0 6px 20px rgba(56, 189, 248, 0.45);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.55);
      opacity: 0.95;
    }
    button.secondary {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: none;
      margin-left: 8px;
    }
    .social-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button.google {
      background: #ffffff;
      color: #111827;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.4);
    }
    #status {
      font-size: 0.85rem;
      color: #a5b4fc;
      margin-top: 8px;
      white-space: pre-wrap;
    }
    .section {
      margin-top: 18px;
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(30, 64, 175, 0.8);
    }
    .section h2 {
      margin: 0 0 6px;
      font-size: 1.05rem;
    }
    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 0.7rem;
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid rgba(56, 189, 248, 0.4);
      color: #bae6fd;
      margin-left: 6px;
    }
    a {
      color: #38bdf8;
      text-decoration: none;
      font-size: 0.85rem;
    }
    a:hover {
      text-decoration: underline;
    }
    code {
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Linglear</h1>
    <p>Basic Cognito login demo. Main login uses email/password; Google is a side option.</p>

    <div>
      <button id="loginBtn">Log in / Sign up</button>
      <button id="logoutBtn" class="secondary" style="display:none;">Log out</button>

      <div class="social-row">
        <button id="googleBtn" class="google">Continue with Google</button>
      </div>

      <div id="status">[init] Checking login status…</div>
    </div>

    <!-- PUBLIC AREA -->
    <div class="section" id="publicSection">
      <h2>Public area</h2>
      <p>Everyone can see this, even if they’re not logged in.</p>
    </div>

    <!-- MEMBER-ONLY AREA -->
    <div class="section" id="memberSection" style="display:none;">
      <h2>
        Member area
        <span class="tag">auth required</span>
      </h2>
      <p id="welcomeText">Welcome!</p>
      <p style="font-size:0.85rem; color:#9ca3af;">
        This is where you’ll eventually put your dashboard, library, SRS, or whatever you only want logged-in users to see.
      </p>
    </div>

    <div style="margin-top:10px; font-size:0.75rem; color:#6b7280;">
      Problems logging in? Check the console (<code>F12 → Console</code>).  
      Cognito callback must match <code>REDIRECT_URI</code> exactly.
    </div>
  </div>

  <script>
    // ================== CONFIG ==================
    const COGNITO_DOMAIN = "https://us-east-1rdnegqer1.auth.us-east-1.amazoncognito.com";
    const CLIENT_ID = "5s39n3sffohs0nhf6i534f7d9h";
    const REDIRECT_URI = "https://linglear.com/";
    const SCOPES = "openid email";  // subset of your allowed scopes

    // ================== ELEMENTS ==================
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const googleBtn = document.getElementById("googleBtn");
    const statusEl = document.getElementById("status");
    const publicSection = document.getElementById("publicSection");
    const memberSection = document.getElementById("memberSection");
    const welcomeText = document.getElementById("welcomeText");

    function log(msg, data) {
      const prefix = "[LINGLEAR AUTH]";
      if (data !== undefined) {
        console.log(prefix, msg, data);
      } else {
        console.log(prefix, msg);
      }
      statusEl.textContent = `${prefix} ${msg}`;
    }

    // ================== URL BUILDERS ==================
    function buildLoginUrl(identityProvider) {
      const params = new URLSearchParams({
        client_id: CLIENT_ID,
        response_type: "token", // implicit: tokens in URL hash
        scope: SCOPES,
        redirect_uri: REDIRECT_URI,
      });
      if (identityProvider) {
        params.set("identity_provider", identityProvider);
      }
      const url = `${COGNITO_DOMAIN}/oauth2/authorize?${params.toString()}`;
      log(`Built login URL${identityProvider ? " (" + identityProvider + ")" : ""}: ${url}`);
      return url;
    }

    function buildLogoutUrl() {
      const params = new URLSearchParams({
        client_id: CLIENT_ID,
        logout_uri: REDIRECT_URI,
      });
      const url = `${COGNITO_DOMAIN}/logout?${params.toString()}`;
      log(`Built logout URL: ${url}`);
      return url;
    }

    // ================== HASH PARSING ==================
    function parseHashTokens() {
      if (!location.hash || location.hash.length <= 1) return null;
      const hash = location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const idToken = params.get("id_token");
      const accessToken = params.get("access_token");
      const expiresIn = params.get("expires_in");
      if (!idToken && !accessToken) return null;
      const tokens = {
        idToken,
        accessToken,
        expiresIn: expiresIn ? parseInt(expiresIn, 10) : null,
      };
      log("Parsed tokens from hash.", tokens);
      return tokens;
    }

    function parseHashError() {
      if (!location.hash || location.hash.length <= 1) return null;
      const hash = location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const error = params.get("error");
      const description = params.get("error_description");
      if (!error) return null;
      const err = {
        error,
        description: description ? decodeURIComponent(description) : null,
      };
      console.error("[LINGLEAR AUTH] Error from Cognito:", err);
      return err;
    }

    // ================== JWT & SESSION ==================
    function decodeJwtPayload(token) {
      if (!token) return null;
      try {
        const payload = token.split(".")[1];
        const normalized = payload.replace(/-/g, "+").replace(/_/g, "/");
        const json = atob(normalized);
        const parsed = JSON.parse(json);
        log("Decoded JWT payload.", parsed);
        return parsed;
      } catch (e) {
        console.warn("[LINGLEAR AUTH] Failed to decode JWT:", e);
        return null;
      }
    }

    function saveSession(tokens) {
      const now = Math.floor(Date.now() / 1000);
      let exp = null;
      const payload = decodeJwtPayload(tokens.idToken || tokens.accessToken);
      if (payload && payload.exp) {
        exp = payload.exp;
      } else if (tokens.expiresIn) {
        exp = now + tokens.expiresIn;
      }
      const session = {
        idToken: tokens.idToken || null,
        accessToken: tokens.accessToken || null,
        expiresAt: exp,
      };
      localStorage.setItem("linglear_session", JSON.stringify(session));
      log("Saved session to localStorage.", session);
      return session;
    }

    function loadSession() {
      const raw = localStorage.getItem("linglear_session");
      if (!raw) {
        log("No existing session in localStorage.");
        return null;
      }
      try {
        const session = JSON.parse(raw);
        if (!session || !session.idToken) {
          log("Session in localStorage is invalid (no idToken).");
          return null;
        }
        const now = Math.floor(Date.now() / 1000);
        if (session.expiresAt && now > session.expiresAt) {
          log("Existing session is expired. Clearing.");
          localStorage.removeItem("linglear_session");
          return null;
        }
        log("Loaded existing session from localStorage.", session);
        return session;
      } catch (e) {
        console.warn("[LINGLEAR AUTH] Failed to parse session from localStorage:", e);
        localStorage.removeItem("linglear_session");
        return null;
      }
    }

    function clearSession() {
      localStorage.removeItem("linglear_session");
      log("Cleared session from localStorage.");
    }

    // ================== UI HELPERS ==================
    function applyLoggedOutUI(extra) {
      let msg = "You are not logged in.";
      if (extra) msg += " " + extra;
      log(msg);
      memberSection.style.display = "none";
      publicSection.style.display = "block";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    }

    function applyLoggedInUI(session) {
      const payload = decodeJwtPayload(session.idToken);
      const name =
        (payload && (payload.name || payload.email || payload["cognito:username"])) ||
        "Linglear member";

      log(`User is logged in as: ${name}`);
      welcomeText.textContent = `Welcome, ${name}!`;
      memberSection.style.display = "block";
      publicSection.style.display = "block";
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
    }

    // ================== BUTTON HANDLERS ==================
    loginBtn.addEventListener("click", () => {
      const url = buildLoginUrl(); // default: Cognito email/password
      log("Redirecting to Cognito Hosted UI (Cognito user pool).");
      window.location.href = url;
    });

    googleBtn.addEventListener("click", () => {
      const url = buildLoginUrl("Google");
      log("Redirecting to Cognito Hosted UI (Google).");
      window.location.href = url;
    });

    logoutBtn.addEventListener("click", () => {
      clearSession();
      const url = buildLogoutUrl();
      log("Redirecting to Cognito logout.");
      window.location.href = url;
    });

    // ================== INIT FLOW ==================
    (function init() {
      console.log("[LINGLEAR AUTH] --- INIT START ---");
      console.log("[LINGLEAR AUTH] location.href =", window.location.href);
      console.log("[LINGLEAR AUTH] location.hash =", window.location.hash);
      console.log("[LINGLEAR AUTH] COGNITO_DOMAIN =", COGNITO_DOMAIN);
      console.log("[LINGLEAR AUTH] CLIENT_ID =", CLIENT_ID);
      console.log("[LINGLEAR AUTH] REDIRECT_URI =", REDIRECT_URI);
      console.log("[LINGLEAR AUTH] SCOPES =", SCOPES);

      const hashError = parseHashError();
      if (hashError) {
        applyLoggedOutUI(
          `Login error: ${hashError.error}${
            hashError.description ? " – " + hashError.description : ""
          }`
        );
        console.log("[LINGLEAR AUTH] --- INIT END (error) ---");
        return;
      }

      const tokensFromHash = parseHashTokens();
      if (tokensFromHash) {
        const session = saveSession(tokensFromHash);
        if (window.location.href.startsWith(REDIRECT_URI)) {
          log("Replacing history state to remove token hash from URL.");
          history.replaceState({}, document.title, REDIRECT_URI);
        } else {
          log(
            "Not replacing history state because href doesn't start with REDIRECT_URI. href=" +
              window.location.href
          );
        }
        applyLoggedInUI(session);
        console.log("[LINGLEAR AUTH] --- INIT END (from tokens) ---");
        return;
      }

      const existingSession = loadSession();
      if (existingSession) {
        applyLoggedInUI(existingSession);
      } else {
        applyLoggedOutUI();
      }
      console.log("[LINGLEAR AUTH] --- INIT END ---");
    })();
  </script>
</body>
</html>
